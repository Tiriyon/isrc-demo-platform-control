apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: application-deployer
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  
  generators:
    - matrix:
        generators:
          - git:
              repoURL: git@github.com:Tiriyon/isrc-demo-platform-control.git
              revision: main
              files:
                - path: "applications/*.yaml"
          - git:
              repoURL: git@github.com:Tiriyon/isrc-demo-platform-control.git
              revision: main
              files:
                - path: "environments/*.yaml"
  
  template:
    metadata:
      name: '{{.application.name}}-{{.environment.name}}'
      namespace: argocd
      labels:
        app: '{{.application.name}}'
        environment: '{{.environment.name}}'
        managed-by: application-deployer
        deployment-strategy: '{{default "files" .application.valueStrategy}}'
      annotations:
        application-source: '{{.application.source.repoURL}}'
        application-path: '{{.application.source.path}}'
        environment-namespace: '{{.environment.namespace}}'
    
    spec:
      project: '{{default "applications" .application.project}}'
      sources:
        - repoURL: '{{.application.source.repoURL}}'
          targetRevision: '{{.application.source.targetRevision}}'
          path: '{{.application.source.path}}'
          helm:
            releaseName: '{{.application.name}}'
            valueFiles:
              - $values/{{default (printf "values/%s" .application.name) .application.valuesPath}}/base.yaml
              - $values/{{default (printf "values/%s" .application.name) .application.valuesPath}}/{{.environment.name}}.yaml
        - repoURL: git@github.com:Tiriyon/isrc-demo-platform-control.git
          targetRevision: main
          ref: values
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{.environment.namespace}}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        managedNamespaceMetadata:
          labels:
            environment: '{{.environment.name}}'
            managed-by: argocd
            application: '{{.application.name}}'
      ignoreDifferences:
        - group: apps
          kind: Deployment
          jsonPointers:
            - /spec/replicas
      info:
        - name: Environment
          value: '{{.environment.name}}'
        - name: Application
          value: '{{.application.name}}'
        - name: Namespace
          value: '{{.environment.namespace}}'
  
  templatePatch: |
    {{- $envName := .environment.name }}
    {{- $envList := .application.environments }}
    {{- if not (has $envName $envList) }}
    metadata:
      name: skip-{{.application.name}}-{{.environment.name}}
    spec:
      project: skip-this-combination
    {{- end }}
